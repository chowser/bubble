<!--
Reference: https://jrue.github.io/coding/2014/exercises/basicbubblepackchart/
-->
<!doctype html>
<html lang="en">
<head>
   <!-- Required meta tags -->
   <meta charset="utf-8">
   <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

   <!-- Bootstrap CSS -->
   <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css" integrity="sha384-9gVQ4dYFwwWSjIDZnLEWnxCjeSWFphJiwGPXr1jddIhOegiu1FwO5qRGvFXOdJZ4" crossorigin="anonymous">

   <title>Popular Name Bubbles</title>

</head>
<body>
   <center>
      <div class="container-fluid">
         <form class="form-inline">
            <label class="my-1 mr-2" for="inputNumber">How many?</label>
            <select id="inputNumber" class="custom-select my-1 mr-sm-2">
               <option selected=true value="top10">Top 10</option>
               <option value="top100">Top 100</option>
               <option value="top500">Top 500</option>
               <option value="bottom10">Bottom 10</option>
               <option value="bottom100">Bottom 100</option>
               <option value="bottom500">Bottom 500</option>
            </select>
            <div class="form-check form-check-inline">
               <input class="form-check-input" type="checkbox" id="btnMale" checked>
               <label class="form-check-label" for="btnMale">Male</label>
            </div>
            <div class="form-check form-check-inline">
               <input class="form-check-input" type="checkbox" id="btnFemale" checked>
               <label class="form-check-label" for="btnFemale">Female</label>
            </div>
            <div class="col-auto">
               <button id="btnDraw" type="button" class="btn btn-secondary mb-2">Draw</button>
            </div>
         </form>
      </div>
      <div id="chart" align="center"
   </div>
</div>
</div>
</center>
</body>

<!-- jQuery first, then Popper.js, then Bootstrap JS, then d3.js -->
<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.0/umd/popper.min.js" integrity="sha384-cs/chFZiN24E4KMATLdqdvsezGxaGsi4hLGOzlXwp5UZB1LY//20VyM2taTB4QvJ" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js" integrity="sha384-uefMccjFJAIv6A+rW+L4AHf99KvxDjWSu1z9VI8SKNVmz4sk7buKt/6v9KI65qnm" crossorigin="anonymous"></script>
<script src="https://d3js.org/d3.v4.min.js"></script>

<script type="text/javascript">
   $(document).ready(function(){
   // max size of the chart
   var diameter = 1280

   // Set packing Algorithm
   // https://github.com/d3/d3-3.x-api-reference/blob/master/Pack-Layout.md#sort
   var bubble = d3.pack()
   .size([diameter, diameter])
   .padding(5)
   .sort(null)

   var svg = d3.select("body")
   .append("svg")
   .attr("width", diameter)
   .attr("height", diameter)
   .attr("class", "bubble")
   .style("fill", "white")

   var nodes,bubbles,loadedData
   var selectionMale = $("#btnMale").prop('checked')
   var selectionFemale = $("#btnMale").prop('checked')
   var selectionDropdown = $("#inputNumber").val()

   // load and process data from csv
   d3.csv("data/babynames.csv", function(data) {
      //convert numerical values from strings to numbers
      data = data.map(function(d){
         d.value = +d.count
         return d
      }) // end data.map()

      // add color data
      data = data.map(function(d){
         if(d.gender == "M"){
            d.color = "#42d7f4"
            return d
         }
         else if(d.gender == "F"){
            d.color = "#f780dd"
            return d
         }
      })  //end data.map()

      loadedData = data
   }) // end d3.csv()

   // Fisher Yates Sort Algorithm https://bost.ocks.org/mike/shuffle/
   function shuffle(array) {
      console.log("shuffle()")
      var m = array.length, t, i
      // while there remain elements to shuffle
      while (m) {
         // pick a remaining element
         i = Math.floor(Math.random() * m--)
         // swap it with the current element
         t = array[m]
         array[m] = array[i]
         array[i] = t
      }
      return array
   } // end shuffle

   function sortByName(array){
      array.sort(function(a,b){
         var nameA = a.name.toUpperCase() // ignore upper and lowercase
         var nameB = b.name.toUpperCase() // ignore upper and lowercase
         if (nameA < nameB) {
            return -1
         }
         if (nameA > nameB) {
            return 1
         }
         // names must be equal
         return 0
      })
      return array
   }

   function filter(data){
      console.log("filter()")
      var maleArray = data.filter(function(d){
         if(selectionMale){
            return d.gender == "M"
         }
      })

      var femaleArray = data.filter(function(d){
         if(selectionFemale){
            return d.gender == "F"
         }
      })

      if(selectionDropdown == "top10"){
         maleArray = maleArray.slice(0,10)
         femaleArray = femaleArray.slice(0,10)
      }
      else if(selectionDropdown == "top100"){
         maleArray = maleArray.slice(0,100)
         femaleArray = femaleArray.slice(0,100)
      }
      else if(selectionDropdown == "top500"){
         maleArray = maleArray.slice(0,500)
         femaleArray = femaleArray.slice(0,500)
      }
      else if(selectionDropdown == "bottom10"){
         maleArray = maleArray.slice(maleArray.length - 10,maleArray.length - 1)
         femaleArray = femaleArray.slice(femaleArray.length - 10,femaleArray.length - 1)
      }
      else if(selectionDropdown == "bottom100"){
         maleArray = maleArray.slice(maleArray.length - 100,maleArray.length - 1)
         femaleArray = femaleArray.slice(femaleArray.length - 100,femaleArray.length - 1)
      }
      else if(selectionDropdown == "bottom500"){
         maleArray = maleArray.slice(maleArray.length - 500,maleArray.length - 1)
         femaleArray = femaleArray.slice(femaleArray.length - 500,femaleArray.length - 1)
      }


      var mergedArray = sortByName(maleArray.concat(femaleArray))

      console.log("mergedArray")
      console.log(mergedArray)
      return mergedArray
   } // end filter()

   function draw(data){
      console.log("draw()")
      // create bubble nodes
      nodes = bubble.nodes({children:data})

      // setup the chart
      bubbles = svg.append("g")
      .attr("transform", "translate(0,0)")
      .selectAll(".bubble")
      .data(nodes)
      .enter()

      // create the bubbles
      bubbles.append("circle")
      .attr("r", function(d){ return d.r })
      .attr("cx", function(d){ return d.x })
      .attr("cy", function(d){ return d.y })
      .style("fill", function(d){ return d.color })
      .append("title").text(function(d){
         return "Name: " + d.name + "\n" + "Count: " + d.count
      })

      // format the text for each bubble
      bubbles.append("text")
      .attr("x", function(d){ return d.x })
      .attr("y", function(d){ return d.y + 5 })
      .attr("text-anchor", "middle")
      .text(function(d){ return d.name })
      .style({
         "fill":"white",
         "font-family":"Helvetica Neue, Helvetica, Arial, san-serif",
         "font-size": "14px" })
         console.log("draw() finished")
      } // end draw()

      // attach event handlers to form
      $("#btnMale").change(function(){
         console.log("btnMale clicked")
         selectionMale = $(this).prop('checked')
         console.log($(this).prop('checked'))
      }) // end change()

      $("#btnFemale").change(function(){
         console.log("btnFemale clicked")
         selectionFemale = $(this).prop('checked')
         console.log($(this).prop('checked'))
      }) // end change()

      $("#inputNumber").change(function(){
         console.log("inputNumber clicked")
         selectionDropdown = $("#inputNumber").val()
         console.log(selectionDropdown)
      }) // end change()

      $("#btnDraw").click(function(){
         console.log("btnDraw clicked")
         if(selectionMale || selectionFemale){
            filteredData = filter(loadedData)
            console.log("loadedData")
            console.log(loadedData)
            console.log("filteredData")
            console.log(filteredData)
            draw(filteredData)
         }
         else{
            alert("You must select a gender.")
         }
      }) // end click()
   }) // end $(document).ready()
</script>
</html>
