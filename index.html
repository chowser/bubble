<!--
general references:
https://jrue.github.io/coding/2014/exercises/basicbubblepackchart/

popular baby names data source
https://www.ssa.gov/cgi-bin/popularnames.cgi
-->
<!doctype html>
<head>
<title>Popular Name Bubbles</title>

<link
rel="stylesheet"
href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css">

<script src="https://code.jquery.com/jquery-1.12.4.js"></script>
<script
   src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js">
</script>
<script src="https://d3js.org/d3.v3.min.js"></script>

</head>

<body>
   <center>
      <div style="max-width:1000px; word-wrap:break-word;">
      The following is a bubble chart that allows a user to select the top
      10, 50, and 100 baby names, as well as the bottom 10, 50, and 100 baby
      names.  The user can select to generate either male, female, or both
      gender names, and the chart will generate by clicking the "Generate"
      button. The data was sourced from the Social Security Administration.
      </div>
      <div class="container-fluid">
         <form class="form-inline justify-content-center">
            <label class="my-1 mr-2" for="inputNumber">How many?</label>
            <select id="inputNumber" class="custom-select my-1 mr-sm-2">
               <option selected=true value="top10">Top 10</option>
               <option value="top50">Top 50</option>
               <option value="top100">Top 100</option>
               <option value="bottom10">Bottom 10</option>
               <option value="bottom50">Bottom 50</option>
               <option value="bottom100">Bottom 100</option>
            </select>
            <div class="form-check form-check-inline">
               <input class="form-check-input" type="checkbox"
                  id="btnMale" checked>
               <label class="form-check-label" for="btnMale">Male</label>
            </div>
            <div class="form-check form-check-inline">
               <input class="form-check-input" type="checkbox"
                  id="btnFemale" checked>
               <label class="form-check-label" for="btnFemale">Female</label>
            </div>
            <div class="col-auto">
               <button id="btnDraw" type="button"
                  class="btn btn-secondary mb-2">Generate</button>
            </div>
         </form>
      </div>
      <div id="chart"></div>
   </center>
</body>



<script type="text/javascript">
   $(document).ready(function(){
   // max size of the chart
   var diameter = 1000

   // set packing Algorithm
   // https://github.com/d3/d3-3.x-api-reference/blob/master/Pack-Layout.md#sort
   var bubble = d3.layout.pack()
   .size([diameter, diameter])
   .padding(5)
   .sort(null) // disable layout sorting - makes chart look better

   var svg = d3.select("#chart")
   .append("svg")
   .attr("width", diameter)
   .attr("height", diameter)
   .attr("class", "bubble")
   .style("fill", "white")

   var nodes,bubbles,loadedData
   var selectionMale = $("#btnMale").prop('checked')
   var selectionFemale = $("#btnMale").prop('checked')
   var selectionDropdown = $("#inputNumber").val()

   // load and process data from csv
   d3.csv("data/babynames.csv", function(data) {
      //convert numerical values from strings to numbers
      data = data.map(function(d){
         d.value = +d.count
         return d
      }) // end data.map()

      // add color data
      data = data.map(function(d){
         if(d.gender == "M"){
            d.color = "#42d7f4" // blue
            return d
         }
         else if(d.gender == "F"){
            d.color = "#f780dd" // pink
            return d
         }
      })  //end data.map()

      loadedData = data
   }) // end d3.csv()

   // Fisher Yates Sort Algorithm
   // https://bost.ocks.org/mike/shuffle/
   function shuffle(array) {
      var m = array.length, t, i
      // while there remain elements to shuffle
      while (m) {
         // pick a remaining element
         i = Math.floor(Math.random() * m--)
         // swap it with the current element
         t = array[m]
         array[m] = array[i]
         array[i] = t
      }
      return array
   } // end shuffle

   function sortByName(array){
      array.sort(function(a,b){
         var nameA = a.name.toUpperCase() // ignore upper and lowercase
         var nameB = b.name.toUpperCase() // ignore upper and lowercase
         if (nameA < nameB) {
            return -1
         }
         if (nameA > nameB) {
            return 1
         }
         // names must be equal
         return 0
      })
      return array
   }

   function filter(data){
      var maleArray = data.filter(function(d){
         if(selectionMale){
            return d.gender == "M"
         }
      })

      var femaleArray = data.filter(function(d){
         if(selectionFemale){
            return d.gender == "F"
         }
      })

      if(selectionDropdown == "top10"){
         maleArray = maleArray.slice(0,10)
         femaleArray = femaleArray.slice(0,10)
      }

      else if(selectionDropdown == "top50"){
         maleArray = maleArray.slice(0,50)
         femaleArray = femaleArray.slice(0,50)
      }

      else if(selectionDropdown == "top100"){
         maleArray = maleArray.slice(0,100)
         femaleArray = femaleArray.slice(0,100)
      }

      else if(selectionDropdown == "bottom10"){
         maleArray = maleArray.slice(maleArray.length
            - 10,maleArray.length - 1)
         femaleArray = femaleArray.slice(femaleArray.length
            - 10,femaleArray.length - 1)
      }

      else if(selectionDropdown == "bottom50"){
         maleArray = maleArray.slice(maleArray.length
            - 50,maleArray.length - 1)
         femaleArray = femaleArray.slice(femaleArray.length
            - 50,femaleArray.length - 1)
      }

      else if(selectionDropdown == "bottom100"){
         maleArray = maleArray.slice(maleArray.length
            - 100,maleArray.length - 1)
         femaleArray = femaleArray.slice(femaleArray.length
            - 100,femaleArray.length - 1)
      }

      var mergedArray = sortByName(maleArray.concat(femaleArray))

      return mergedArray
   } // end filter()

   function draw(data){
      // create bubble nodes
      nodes = bubble.nodes({children:data})

      // setup the chart
      bubbles = svg.append("g")
      .attr("transform", "translate(0,0)")
      .selectAll(".bubble")
      .data(nodes)
      .enter()

      // create the bubbles
      bubbles.append("circle")
      .attr("r", function(d){ return d.r })
      .attr("cx", function(d){ return d.x })
      .attr("cy", function(d){ return d.y })
      .style("fill", function(d){ return d.color })
      .append("title").text(function(d){
         return "Name: " + d.name + "\n" + "Count: " + d.count
      })

      // format the text for each bubble
      bubbles.append("text")
      .attr("x", function(d){ return d.x })
      .attr("y", function(d){ return d.y + 5 })
      .attr("text-anchor", "middle")
      .text(function(d){ return d.name })
      .style({
         "fill":"black",
         "font-family":"Helvetica Neue, Helvetica, Arial, san-serif",
         "font-size": "14px" })
      } // end draw()

      // attach event handlers to form
      $("#btnMale").change(function(){
         selectionMale = $(this).prop('checked')
      }) // end change()

      $("#btnFemale").change(function(){
         selectionFemale = $(this).prop('checked')
      }) // end change()

      $("#inputNumber").change(function(){
         selectionDropdown = $("#inputNumber").val()
      }) // end change()

      $("#btnDraw").click(function(){
         if(selectionMale || selectionFemale){
            finalData = shuffle(filter(loadedData))
            draw(finalData)
         }
         else{
            alert("You must select a gender.")
         }
      }) // end click()
   }) // end $(document).ready()
</script>
</html>
